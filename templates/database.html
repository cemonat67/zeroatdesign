{% extends "base.html" %}

{% block title %}Database{% endblock %}

{% block page_header %}
<div class="page-title text-center">
    <h1>Database</h1>
    <p>CO2 verileri ve i≈ülem y√∂netimi</p>
</div>
{% endblock %}

{% block content %}
<div class="database-container">
    <!-- Veritabanƒ± ƒ∞statistikleri -->
    <div class="database-stats">
        <div class="stat-card">
            <div class="stat-number" id="finished-operations-count">-</div>
            <div class="stat-label">Bitmi≈ü √úr√ºn ƒ∞≈ülemleri</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="garment-processes-count">-</div>
            <div class="stat-label">Konfeksiyon S√ºre√ßleri</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="master-co2-count">-</div>
            <div class="stat-label">Master CO2 Verileri</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="categories-count">-</div>
            <div class="stat-label">√úr√ºn Kategorileri</div>
        </div>
    </div>

    <!-- Arama ve Filtreleme -->
    <div class="database-card">
        <div class="database-card-header">
            <h5>üîç Arama ve Filtreleme</h5>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="search-input">ƒ∞≈ülem Arama</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-input" placeholder="ƒ∞≈ülem, kategori veya a√ßƒ±klama ara...">
                        <button class="btn btn-primary" type="button" onclick="searchOperations()">
                            <i class="fas fa-search"></i> Ara
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="category-filter">Kategori Filtresi</label>
                    <select class="form-control" id="category-filter" onchange="filterByCategory()">
                        <option value="">T√ºm Kategoriler</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="data-type-filter">Veri Tipi</label>
                    <select class="form-control" id="data-type-filter" onchange="filterByDataType()">
                        <option value="all">T√ºm Veriler</option>
                        <option value="finished_product_operations">Bitmi≈ü √úr√ºn ƒ∞≈ülemleri</option>
                        <option value="garment_processes">Konfeksiyon S√ºre√ßleri</option>
                        <option value="master_co2_data">Master CO2 Verileri</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- CO2 Hesaplama Aracƒ± -->
    <div class="database-card">
        <div class="database-card-header">
            <h5>üßÆ CO2 Hesaplama Aracƒ±</h5>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="product-name">√úr√ºn Adƒ±</label>
                    <input type="text" class="form-control" id="product-name" placeholder="√úr√ºn adƒ±nƒ± girin...">
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="product-group">√úr√ºn Grubu</label>
                    <select class="form-control" id="product-group" onchange="loadOperationsByGroup()">
                        <option value="">√úr√ºn grubu se√ßin...</option>
                        <option value="Ti≈ü√∂rt">Ti≈ü√∂rt</option>
                        <option value="Sweatshirt">Sweatshirt</option>
                        <option value="Denim">Denim</option>
                        <option value="Spor giyim">Spor giyim</option>
                        <option value="Dƒ±≈ü giyim">Dƒ±≈ü giyim</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-success mt-4" onclick="calculateCO2()">
                    <i class="fas fa-calculator"></i> CO2 Hesapla
                </button>
            </div>
        </div>
        
        <!-- Se√ßilen ƒ∞≈ülemler -->
        <div class="row mt-3">
            <div class="col-12">
                <h6>Se√ßilen ƒ∞≈ülemler:</h6>
                <div id="selected-operations" class="selected-operations-container">
                    <p class="text-muted">Hen√ºz i≈ülem se√ßilmedi</p>
                </div>
            </div>
        </div>
        
        <!-- Hesaplama Sonucu -->
        <div id="calculation-result" class="mt-3" style="display: none;">
            <div class="alert">
                <h6>Hesaplama Sonucu:</h6>
                <div id="calculation-details"></div>
            </div>
        </div>
    </div>

    <!-- Veri Tablosu -->
    <div class="database-card">
        <div class="database-card-header">
            <h5>üìã Veri Tablosu</h5>
            <div>
                <span class="badge" id="results-count">0 sonu√ß</span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table" id="data-table">
                <thead>
                    <tr>
                        <th>Se√ß</th>
                        <th>Kategori</th>
                        <th>ƒ∞≈ülem/S√ºre√ß</th>
                        <th>A√ßƒ±klama</th>
                        <th>√úr√ºn Gruplarƒ±</th>
                        <th>CO2 (kgCO2e/√ºr√ºn)</th>
                        <th>Not</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <tr>
                        <td colspan="7" class="text-center text-muted">Veri y√ºkleniyor...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Database Page Styles - Aligned with Design System */
.database-container {
    max-width: 1200px;
    margin: auto;
    padding: 24px;
    background: var(--bg);
    color: var(--ink);
}

.database-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: var(--brand);
    transform: translateY(-2px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--brand);
    margin-bottom: 8px;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--muted);
    font-weight: 500;
}

.database-card {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 20px;
}

.database-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--line);
}

.database-card-header h5 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--ink);
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--ink);
    font-size: 0.9rem;
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--ink);
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control::placeholder {
    color: var(--muted);
}

.btn {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: var(--brand);
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.btn-success {
    background: var(--ok);
    color: white;
}

.btn-success:hover {
    background: #15803d;
    transform: translateY(-1px);
}

.selected-operations-container {
    min-height: 60px;
    border: 2px dashed var(--line);
    border-radius: 12px;
    padding: 16px;
    background: var(--bg);
    color: var(--muted);
}

.operation-tag {
    display: inline-block;
    background: var(--brand);
    color: white;
    padding: 6px 12px;
    margin: 4px;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.operation-tag:hover {
    background: #2563eb;
    transform: scale(1.05);
}

.operation-tag .remove-btn {
    margin-left: 8px;
    cursor: pointer;
    font-weight: bold;
    opacity: 0.8;
}

.operation-tag .remove-btn:hover {
    opacity: 1;
}

.table-responsive {
    background: var(--panel);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--line);
}

.table {
    margin: 0;
    color: var(--ink);
    background: transparent;
}

.table th {
    background: var(--bg);
    border: none;
    border-bottom: 1px solid var(--line);
    font-weight: 600;
    color: var(--ink);
    padding: 16px;
    font-size: 0.9rem;
}

.table td {
    border: none;
    border-bottom: 1px solid var(--line);
    padding: 14px 16px;
    font-size: 0.9rem;
}

.table tbody tr:hover {
    background: rgba(59, 130, 246, 0.05);
}

.table tbody tr:last-child td {
    border-bottom: none;
}

.co2-range {
    font-weight: 600;
    color: var(--ok);
}

.btn-select-operation {
    padding: 4px 10px;
    font-size: 0.8rem;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-select-operation:hover {
    background: #2563eb;
    transform: scale(1.05);
}

.alert {
    background: rgba(22, 163, 74, 0.1);
    border: 1px solid var(--ok);
    border-radius: 12px;
    padding: 16px;
    color: var(--ink);
}

.alert h6 {
    color: var(--ok);
    margin-bottom: 8px;
}

.badge {
    background: var(--brand);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.input-group {
    display: flex;
    gap: 0;
}

.input-group .form-control {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    border-right: none;
}

.input-group .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.row {
    display: flex;
    flex-wrap: wrap;
    margin: -8px;
}

.col-md-3, .col-md-4, .col-md-6, .col-12 {
    padding: 8px;
}

.col-md-3 { flex: 0 0 25%; }
.col-md-4 { flex: 0 0 33.333333%; }
.col-md-6 { flex: 0 0 50%; }
.col-12 { flex: 0 0 100%; }

@media (max-width: 768px) {
    .col-md-3, .col-md-4, .col-md-6 {
        flex: 0 0 100%;
    }
    
    .database-stats {
        grid-template-columns: 1fr;
    }
}
</style>

});
</script>
{% endblock %}

{% block extra_js %}
<script>
let selectedOperations = [];
let allData = [];

// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseStats();
    loadCategories();
    loadAllData();
});

// Veritabanƒ± istatistiklerini y√ºkle
function loadDatabaseStats() {
    fetch('/api/database/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('finished-operations-count').textContent = stats.finished_product_operations || 0;
                document.getElementById('garment-processes-count').textContent = stats.garment_processes || 0;
                document.getElementById('master-co2-count').textContent = stats.master_co2_data || 0;
                document.getElementById('categories-count').textContent = stats.product_categories || 0;
            }
        })
        .catch(error => console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error));
}

// Kategorileri y√ºkle
function loadCategories() {
    fetch('/api/categories')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const categorySelect = document.getElementById('category-filter');
                const categories = new Set();
                
                // T√ºm tablolardan kategorileri topla
                Object.values(data.categories_by_table).forEach(catList => {
                    catList.forEach(cat => categories.add(cat));
                });
                
                // Kategorileri select'e ekle
                Array.from(categories).sort().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Kategori y√ºkleme hatasƒ±:', error));
}

// T√ºm verileri y√ºkle
function loadAllData() {
    Promise.all([
        fetch('/api/operations/finished-products').then(r => r.json()),
        fetch('/api/operations/garment-processes').then(r => r.json()),
        fetch('/api/co2-data/master').then(r => r.json())
    ]).then(responses => {
        allData = [];
        
        if (responses[0].success) {
            responses[0].operations.forEach(op => {
                op.data_type = 'finished_product_operations';
                op.operation_name = op.operation_type;
                allData.push(op);
            });
        }
        
        if (responses[1].success) {
            responses[1].processes.forEach(proc => {
                proc.data_type = 'garment_processes';
                proc.operation_name = proc.process_step;
                allData.push(proc);
            });
        }
        
        if (responses[2].success) {
            responses[2].co2_data.forEach(co2 => {
                co2.data_type = 'master_co2_data';
                co2.operation_name = co2.operation;
                allData.push(co2);
            });
        }
        
        displayData(allData);
    }).catch(error => {
        console.error('Veri y√ºkleme hatasƒ±:', error);
        document.getElementById('data-table-body').innerHTML = 
            '<tr><td colspan="7" class="text-center text-danger">Veri y√ºkleme hatasƒ±</td></tr>';
    });
}

// Verileri tabloda g√∂ster
function displayData(data) {
    const tbody = document.getElementById('data-table-body');
    const resultsCount = document.getElementById('results-count');
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Veri bulunamadƒ±</td></tr>';
        resultsCount.textContent = '0 sonu√ß';
        return;
    }
    
    tbody.innerHTML = data.map(item => {
        const co2Display = item.co2_range || 
            (item.co2_min && item.co2_max ? `${item.co2_min}-${item.co2_max}` : 
             (item.co2_min ? item.co2_min.toString() : 'N/A'));
        
        return `
            <tr>
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-select-operation" 
                            onclick="selectOperation(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <i class="fas fa-plus"></i>
                    </button>
                </td>
                <td>${item.category || item.upper_category || ''}</td>
                <td>${item.operation_name || ''}</td>
                <td>${item.description || ''}</td>
                <td>${item.applicable_product_groups || ''}</td>
                <td><span class="co2-range">${co2Display}</span></td>
                <td>${item.notes || item.not || ''}</td>
            </tr>
        `;
    }).join('');
    
    resultsCount.textContent = `${data.length} sonu√ß`;
}

// ƒ∞≈ülem se√ß
function selectOperation(operation) {
    // Aynƒ± i≈ülem zaten se√ßilmi≈üse ekleme
    if (selectedOperations.find(op => op.id === operation.id && op.data_type === operation.data_type)) {
        alert('Bu i≈ülem zaten se√ßilmi≈ü!');
        return;
    }
    
    selectedOperations.push(operation);
    updateSelectedOperationsDisplay();
}

// Se√ßilen i≈ülemleri g√∂ster
function updateSelectedOperationsDisplay() {
    const container = document.getElementById('selected-operations');
    
    if (selectedOperations.length === 0) {
        container.innerHTML = '<p class="text-muted">Hen√ºz i≈ülem se√ßilmedi</p>';
        return;
    }
    
    container.innerHTML = selectedOperations.map((op, index) => `
        <span class="operation-tag">
            ${op.operation_name} (${op.category})
            <span class="remove-btn" onclick="removeOperation(${index})">√ó</span>
        </span>
    `).join('');
}

// ƒ∞≈ülem kaldƒ±r
function removeOperation(index) {
    selectedOperations.splice(index, 1);
    updateSelectedOperationsDisplay();
}

// CO2 hesapla
function calculateCO2() {
    const productName = document.getElementById('product-name').value.trim();
    
    if (!productName) {
        alert('L√ºtfen √ºr√ºn adƒ±nƒ± girin!');
        return;
    }
    
    if (selectedOperations.length === 0) {
        alert('L√ºtfen en az bir i≈ülem se√ßin!');
        return;
    }
    
    fetch('/api/co2-calculator', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            product_name: productName,
            operations: selectedOperations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayCalculationResult(data.calculation);
        } else {
            alert('Hesaplama hatasƒ±: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Hesaplama hatasƒ±:', error);
        alert('Hesaplama sƒ±rasƒ±nda bir hata olu≈ütu!');
    });
}

// Hesaplama sonucunu g√∂ster
function displayCalculationResult(calculation) {
    const resultDiv = document.getElementById('calculation-result');
    const detailsDiv = document.getElementById('calculation-details');
    
    detailsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <strong>√úr√ºn:</strong> ${calculation.product_name}
            </div>
            <div class="col-md-3">
                <strong>Toplam CO2:</strong> ${calculation.total_co2_min.toFixed(3)} - ${calculation.total_co2_max.toFixed(3)} kgCO2e
            </div>
            <div class="col-md-3">
                <strong>Ortalama:</strong> ${calculation.total_co2_avg.toFixed(3)} kgCO2e
            </div>
            <div class="col-md-3">
                <strong>ƒ∞≈ülem Sayƒ±sƒ±:</strong> ${calculation.operation_count}
            </div>
        </div>
    `;
    
    resultDiv.style.display = 'block';
}

// Arama yap
function searchOperations() {
    const searchTerm = document.getElementById('search-input').value.trim();
    
    if (!searchTerm) {
        displayData(allData);
        return;
    }
    
    fetch(`/api/search?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const searchResults = [];
                
                // T√ºm arama sonu√ßlarƒ±nƒ± birle≈ütir
                Object.entries(data.results).forEach(([dataType, results]) => {
                    results.forEach(item => {
                        item.data_type = dataType;
                        if (dataType === 'finished_product_operations') {
                            item.operation_name = item.operation_type;
                        } else if (dataType === 'garment_processes') {
                            item.operation_name = item.process_step;
                        } else if (dataType === 'master_co2_data') {
                            item.operation_name = item.operation;
                        }
                        searchResults.push(item);
                    });
                });
                
                displayData(searchResults);
            }
        })
        .catch(error => console.error('Arama hatasƒ±:', error));
}

// Kategori filtresi
function filterByCategory() {
    const category = document.getElementById('category-filter').value;
    
    if (!category) {
        displayData(allData);
        return;
    }
    
    const filtered = allData.filter(item => 
        (item.category && item.category.includes(category)) ||
        (item.upper_category && item.upper_category.includes(category))
    );
    
    displayData(filtered);
}

// Veri tipi filtresi
function filterByDataType() {
    const dataType = document.getElementById('data-type-filter').value;
    
    if (dataType === 'all') {
        displayData(allData);
        return;
    }
    
    const filtered = allData.filter(item => item.data_type === dataType);
    displayData(filtered);
}

// √úr√ºn grubuna g√∂re i≈ülemleri y√ºkle
function loadOperationsByGroup() {
    const productGroup = document.getElementById('product-group').value;
    
    if (!productGroup) {
        return;
    }
    
    fetch(`/api/operations/by-product-group?product_group=${encodeURIComponent(productGroup)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const groupOperations = data.operations.map(op => {
                    op.data_type = 'finished_product_operations';
                    op.operation_name = op.operation_type;
                    return op;
                });
                displayData(groupOperations);
            }
        })
        .catch(error => console.error('√úr√ºn grubu i≈ülemleri y√ºkleme hatasƒ±:', error));
}

// Enter tu≈üu ile arama
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchOperations();
    }
});
</script>
{% endblock %}